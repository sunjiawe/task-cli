<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} Gantt Chart</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 95%;
            margin: auto;
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        h1 {
            color: #343a40;
            margin: 0;
        }
        .view-switcher button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .view-switcher button.active {
            background-color: #0056b3;
        }
        .gantt-wrapper {
            overflow-x: auto;
        }
        .gantt-chart {
            display: grid;
            grid-template-columns: 200px 1fr;
            position: relative;
        }
        .gantt-tasks {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #dee2e6;
        }
        .gantt-task-name {
            padding: 12px 10px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-bottom: 1px solid #e9ecef;
            height: 30px;
            line-height: 30px;
        }
        .gantt-timeline {
            position: relative;
        }
        .gantt-header {
            display: grid;
            border-bottom: 2px solid #ced4da;
        }
        .gantt-header-unit {
            text-align: center;
            font-size: 12px;
            color: #6c757d;
            padding: 5px 0;
            border-right: 1px solid #e9ecef;
        }
        .gantt-row {
            height: 53px; /* Match task name height + padding/border */
            position: relative;
            border-bottom: 1px solid #e9ecef;
        }
        .gantt-bar {
            position: absolute;
            top: 10px;
            height: 30px;
            background-color: #007bff;
            border-radius: 5px;
            z-index: 1;
            transition: filter 0.2s;
        }
        .gantt-bar.done { background-color: #28a745; }
        .gantt-bar.in_progress { background-color: #ffc107; }
        .gantt-bar.blocked { background-color: #dc3545; }
        .gantt-bar.highlight {
            filter: brightness(1.2);
        }
        .gantt-bar.dimmed {
            filter: brightness(0.7);
        }
        .dependency-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }
        .dependency-line {
            transition: stroke-width 0.2s, stroke 0.2s;
        }
        .dependency-line.highlight {
            stroke: #d63384 !important;
            stroke-width: 2.5 !important;
        }
        #tooltip {
            position: fixed;
            display: none;
            background: #343a40;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #tooltip h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        #tooltip p {
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ project_name }} Gantt Chart</h1>
            <div class="view-switcher">
                <button id="day-view" class="active">Day</button>
                <button id="week-view">Week</button>
                <button id="month-view">Month</button>
            </div>
        </div>
        <div class="gantt-wrapper">
            <div class="gantt-chart" id="gantt-chart">
                <div class="gantt-tasks" id="gantt-tasks"></div>
                <div class="gantt-timeline">
                    <div class="gantt-header" id="gantt-header"></div>
                    <div class="gantt-rows" id="gantt-rows"></div>
                    <svg class="dependency-lines" id="dependency-lines">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#5a6268" />
                            </marker>
                            <marker id="arrowhead-highlight" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#d63384" />
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>
    </div>
    <div id="tooltip"></div>

    <script>
        const tasks = {{ tasks_json }};
        const minDate = new Date('{{ min_date }}');
        const maxDate = new Date('{{ max_date }}');

        const ganttChart = document.getElementById('gantt-chart');
        const ganttTasks = document.getElementById('gantt-tasks');
        const ganttHeader = document.getElementById('gantt-header');
        const ganttRows = document.getElementById('gantt-rows');
        const dependencyLines = document.getElementById('dependency-lines');
        const tooltip = document.getElementById('tooltip');

        let currentView = 'day';

        function renderGantt() {
            ganttTasks.innerHTML = '';
            ganttHeader.innerHTML = '';
            ganttRows.innerHTML = '';
            dependencyLines.querySelectorAll('path').forEach(p => p.remove());

            const timeScale = getTimeScale(currentView);
            ganttHeader.style.gridTemplateColumns = `repeat(${timeScale.units.length}, 1fr)`;

            timeScale.units.forEach(unit => {
                const headerEl = document.createElement('div');
                headerEl.className = 'gantt-header-unit';
                headerEl.textContent = unit;
                ganttHeader.appendChild(headerEl);
            });

            tasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'gantt-task-name';
                taskEl.textContent = task.title;
                taskEl.id = `task-name-${task.id}`;
                ganttTasks.appendChild(taskEl);

                const rowEl = document.createElement('div');
                rowEl.className = 'gantt-row';
                rowEl.id = `task-row-${task.id}`;
                ganttRows.appendChild(rowEl);

                const start = new Date(task.start);
                const end = new Date(task.end);
                const startOffset = getOffset(start, timeScale.startDate, timeScale.unitDuration);
                const duration = getOffset(end, start, timeScale.unitDuration) + 1;

                const barEl = document.createElement('div');
                barEl.className = `gantt-bar ${task.status}`;
                barEl.style.left = `${(startOffset / timeScale.units.length) * 100}%`;
                barEl.style.width = `${(duration / timeScale.units.length) * 100}%`;
                barEl.id = `task-bar-${task.id}`;
                barEl.dataset.taskId = task.id;
                rowEl.appendChild(barEl);
            });

            drawDependencies();
            addHoverEffects();
        }

        function getTimeScale(view) {
            let units = [];
            let startDate = new Date(minDate);
            let unitDuration;

            if (view === 'day') {
                unitDuration = 1000 * 60 * 60 * 24;
                let currentDate = new Date(minDate);
                while(currentDate <= maxDate) {
                    units.push(`${currentDate.getMonth() + 1}/${currentDate.getDate()}`);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            } else if (view === 'week') {
                unitDuration = 1000 * 60 * 60 * 24 * 7;
                startDate.setDate(startDate.getDate() - startDate.getDay());
                let currentDate = new Date(startDate);
                while(currentDate <= maxDate) {
                    units.push(`Week of ${currentDate.getMonth() + 1}/${currentDate.getDate()}`);
                    currentDate.setDate(currentDate.getDate() + 7);
                }
            } else { // month
                unitDuration = 1000 * 60 * 60 * 24 * 30.44; // Average days
                startDate.setDate(1);
                let currentDate = new Date(startDate);
                while(currentDate.getFullYear() < maxDate.getFullYear() || currentDate.getMonth() <= maxDate.getMonth()) {
                    units.push(currentDate.toLocaleString('default', { month: 'short', year: 'numeric' }));
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
            }
            return { units, startDate, unitDuration };
        }

        function getOffset(date1, date2, unitDuration) {
            return Math.floor((date1 - date2) / unitDuration);
        }

        function drawDependencies() {
            tasks.forEach(task => {
                if (task.dependencies && task.dependencies.length > 0) {
                    task.dependencies.forEach(depId => {
                        const fromBar = document.getElementById(`task-bar-${depId}`);
                        const toBar = document.getElementById(`task-bar-${task.id}`);
                        if (fromBar && toBar) {
                            const fromRect = fromBar.getBoundingClientRect();
                            const toRect = toBar.getBoundingClientRect();
                            const containerRect = ganttRows.getBoundingClientRect();

                            const startX = fromRect.right - containerRect.left;
                            const startY = fromRect.top - containerRect.top + fromRect.height / 2;
                            const endX = toRect.left - containerRect.left - 10; // Adjust for arrowhead
                            const endY = toRect.top - containerRect.top + toRect.height / 2;

                            const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            line.setAttribute('d', `M ${startX} ${startY} L ${startX + 20} ${startY} L ${startX + 20} ${endY} L ${endX} ${endY}`);
                            line.setAttribute('stroke', '#5a6268');
                            line.setAttribute('stroke-width', '1.5');
                            line.setAttribute('fill', 'none');
                            line.setAttribute('marker-end', 'url(#arrowhead)');
                            line.classList.add('dependency-line');
                            line.dataset.fromTask = depId;
                            line.dataset.toTask = task.id;
                            dependencyLines.appendChild(line);
                        }
                    });
                }
            });
        }

        function addHoverEffects() {
            document.querySelectorAll('.gantt-bar').forEach(bar => {
                bar.addEventListener('mouseover', (e) => {
                    const taskId = e.target.dataset.taskId;
                    const task = tasks.find(t => t.id === taskId);

                    // Tooltip
                    tooltip.style.display = 'block';
                    tooltip.innerHTML = `<h3>${task.title}</h3><p>${task.description}</p><p><b>Difficulty:</b> ${task.difficulty} | <b>Hours:</b> ${task.estimated_hours}</p>`;

                    // Highlighting
                    document.querySelectorAll('.gantt-bar').forEach(b => b.classList.add('dimmed'));
                    document.querySelectorAll('.dependency-line').forEach(l => l.style.opacity = '0.2');

                    const relatedIds = new Set([taskId]);
                    tasks.forEach(t => {
                        if (t.dependencies.includes(taskId)) relatedIds.add(t.id);
                        if (t.id === taskId) t.dependencies.forEach(d => relatedIds.add(d));
                    });

                    relatedIds.forEach(id => {
                        document.getElementById(`task-bar-${id}`).classList.remove('dimmed');
                        document.getElementById(`task-bar-${id}`).classList.add('highlight');
                    });

                    document.querySelectorAll(`.dependency-line[data-from-task="${taskId}"], .dependency-line[data-to-task="${taskId}"]`).forEach(l => {
                        l.classList.add('highlight');
                        l.setAttribute('marker-end', 'url(#arrowhead-highlight)');
                        l.style.opacity = '1';
                    });
                });

                bar.addEventListener('mouseout', () => {
                    tooltip.style.display = 'none';
                    document.querySelectorAll('.gantt-bar').forEach(b => {
                        b.classList.remove('dimmed', 'highlight');
                    });
                    document.querySelectorAll('.dependency-line').forEach(l => {
                        l.classList.remove('highlight');
                        l.setAttribute('marker-end', 'url(#arrowhead)');
                        l.style.opacity = '1';
                    });
                });

                bar.addEventListener('mousemove', (e) => {
                    tooltip.style.left = `${e.clientX + 15}px`;
                    tooltip.style.top = `${e.clientY + 15}px`;
                });
            });
        }

        document.getElementById('day-view').addEventListener('click', () => { currentView = 'day'; renderGantt(); });
        document.getElementById('week-view').addEventListener('click', () => { currentView = 'week'; renderGantt(); });
        document.getElementById('month-view').addEventListener('click', () => { currentView = 'month'; renderGantt(); });

        renderGantt();
    </script>
</body>
</html>
